# Export Format

## エクスポート機能概要

NoCode UI Builderで作成したUIを、HTML/CSS形式の静的ファイルとしてエクスポートします。ユーザーは生成されたファイルをダウンロードし、任意のWebサーバーにデプロイできます。

### エクスポート形式
- **単一HTMLファイル**: すべてのスタイルをインライン化した単一のHTMLファイル
- **将来的（スコープ外）**: HTML + 外部CSSファイルの分離構成

---

## エクスポート仕様

### 1. 出力ファイル構成（初期プロトタイプ）

```
project-name.html
```

**特徴:**
- すべてのCSSスタイルはインライン（`style` 属性）で記述
- 外部依存なし、単一ファイルで完結
- JavaScriptは含まない（静的HTML/CSSのみ）

### 2. 生成されるHTML構造

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Name - NoCode UI Builder</title>
  <style>
    /* リセットCSS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    /* キャンバスコンテナ */
    .canvas-container {
      position: relative;
      width: 100%;
      min-height: 100vh;
      background-color: #FFFFFF;
    }

    /* 共通スタイル */
    .widget {
      position: absolute;
    }
  </style>
</head>
<body>
  <div class="canvas-container">
    <!-- Widget要素がここに生成される -->
  </div>

  <!-- Generator Comment -->
  <!-- Generated by NoCode UI Builder - https://nocode-ui-builder.vercel.app -->
</body>
</html>
```

---

## Widget別エクスポート仕様

### 1. Text Widget

**入力（canvas_data）:**
```json
{
  "id": "text-1",
  "type": "Text",
  "position": { "x": 100, "y": 50 },
  "size": { "width": 200, "height": 30 },
  "props": {
    "content": "Hello World",
    "fontSize": 24,
    "color": "#1F2937",
    "fontWeight": "bold",
    "textAlign": "center"
  }
}
```

**出力HTML:**
```html
<div class="widget" style="
  position: absolute;
  left: 100px;
  top: 50px;
  width: 200px;
  height: 30px;
  font-size: 24px;
  color: #1F2937;
  font-weight: bold;
  text-align: center;
">
  Hello World
</div>
```

---

### 2. Input Widget

**入力（canvas_data）:**
```json
{
  "id": "input-1",
  "type": "Input",
  "position": { "x": 100, "y": 100 },
  "size": { "width": 300, "height": 40 },
  "props": {
    "label": "Email",
    "placeholder": "Enter your email...",
    "inputType": "email",
    "required": true,
    "width": 300
  }
}
```

**出力HTML:**
```html
<div class="widget" style="
  position: absolute;
  left: 100px;
  top: 100px;
  width: 300px;
">
  <label style="
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
  ">
    Email
  </label>
  <input
    type="email"
    placeholder="Enter your email..."
    required
    style="
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    "
  />
</div>
```

---

### 3. Button Widget

**入力（canvas_data）:**
```json
{
  "id": "button-1",
  "type": "Button",
  "position": { "x": 150, "y": 200 },
  "size": { "width": 160, "height": 48 },
  "props": {
    "text": "Click Me",
    "variant": "primary",
    "size": "medium",
    "color": "#3B82F6",
    "textColor": "#FFFFFF",
    "borderRadius": 8
  }
}
```

**出力HTML:**
```html
<button class="widget" style="
  position: absolute;
  left: 150px;
  top: 200px;
  width: 160px;
  height: 48px;
  background-color: #3B82F6;
  color: #FFFFFF;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  padding: 12px 24px;
  transition: opacity 0.2s;
">
  Click Me
</button>
```

**バリアント別スタイル生成:**

- **Primary**: `background-color: {color}; color: {textColor}; border: none;`
- **Secondary**: `background-color: rgba({color}, 0.1); color: {color}; border: none;`
- **Outline**: `background-color: transparent; color: {color}; border: 1px solid {color};`
- **Ghost**: `background-color: transparent; color: {color}; border: none;`

---

### 4. Image Widget

**入力（canvas_data）:**
```json
{
  "id": "image-1",
  "type": "Image",
  "position": { "x": 50, "y": 300 },
  "size": { "width": 400, "height": 250 },
  "props": {
    "src": "https://via.placeholder.com/400x250",
    "alt": "Placeholder Image",
    "objectFit": "cover",
    "borderRadius": 12,
    "opacity": 1
  }
}
```

**出力HTML:**
```html
<img
  class="widget"
  src="https://via.placeholder.com/400x250"
  alt="Placeholder Image"
  style="
    position: absolute;
    left: 50px;
    top: 300px;
    width: 400px;
    height: 250px;
    object-fit: cover;
    border-radius: 12px;
    opacity: 1;
  "
/>
```

---

### 5. Table Widget

**入力（canvas_data）:**
```json
{
  "id": "table-1",
  "type": "Table",
  "position": { "x": 50, "y": 600 },
  "size": { "width": 600, "height": 200 },
  "props": {
    "columns": [
      { "key": "id", "label": "ID", "width": 60 },
      { "key": "name", "label": "Name", "width": 200 }
    ],
    "data": [
      { "id": 1, "name": "John Doe" },
      { "id": 2, "name": "Jane Smith" }
    ],
    "striped": true,
    "bordered": true,
    "hoverable": false,
    "headerBgColor": "#F3F4F6",
    "headerTextColor": "#111827"
  }
}
```

**出力HTML:**
```html
<div class="widget" style="
  position: absolute;
  left: 50px;
  top: 600px;
  width: 600px;
">
  <table style="
    width: 100%;
    border-collapse: collapse;
  ">
    <thead>
      <tr style="background-color: #F3F4F6; color: #111827;">
        <th style="width: 60px; padding: 12px; border: 1px solid #E5E7EB; text-align: left; font-weight: 600;">ID</th>
        <th style="width: 200px; padding: 12px; border: 1px solid #E5E7EB; text-align: left; font-weight: 600;">Name</th>
      </tr>
    </thead>
    <tbody>
      <tr style="background-color: #FFFFFF;">
        <td style="padding: 12px; border: 1px solid #E5E7EB;">1</td>
        <td style="padding: 12px; border: 1px solid #E5E7EB;">John Doe</td>
      </tr>
      <tr style="background-color: #F9FAFB;">
        <td style="padding: 12px; border: 1px solid #E5E7EB;">2</td>
        <td style="padding: 12px; border: 1px solid #E5E7EB;">Jane Smith</td>
      </tr>
    </tbody>
  </table>
</div>
```

---

### 6. Select Widget

**入力（canvas_data）:**
```json
{
  "id": "select-1",
  "type": "Select",
  "position": { "x": 100, "y": 400 },
  "size": { "width": 250, "height": 40 },
  "props": {
    "label": "Country",
    "options": [
      { "value": "us", "label": "United States" },
      { "value": "jp", "label": "Japan" },
      { "value": "uk", "label": "United Kingdom" }
    ],
    "placeholder": "Select a country...",
    "required": false,
    "width": 250
  }
}
```

**出力HTML:**
```html
<div class="widget" style="
  position: absolute;
  left: 100px;
  top: 400px;
  width: 250px;
">
  <label style="
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
  ">
    Country
  </label>
  <select style="
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #D1D5DB;
    border-radius: 6px;
    font-size: 14px;
    background-color: white;
    cursor: pointer;
  ">
    <option value="" disabled selected>Select a country...</option>
    <option value="us">United States</option>
    <option value="jp">Japan</option>
    <option value="uk">United Kingdom</option>
  </select>
</div>
```

---

## 実装詳細

### HTML生成ロジック (lib/export/html-generator.ts)

```typescript
import { CanvasData, Widget } from '@/types/widget';

export function generateHTML(projectName: string, canvasData: CanvasData): string {
  const widgets = canvasData.components || [];
  const settings = canvasData.settings || {};

  const widgetHTML = widgets
    .map((widget) => generateWidgetHTML(widget))
    .join('\n    ');

  return `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHTML(projectName)} - NoCode UI Builder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .canvas-container {
      position: relative;
      width: 100%;
      min-height: 100vh;
      background-color: ${settings.backgroundColor || '#FFFFFF'};
    }

    .widget {
      position: absolute;
    }
  </style>
</head>
<body>
  <div class="canvas-container">
    ${widgetHTML}
  </div>

  <!-- Generated by NoCode UI Builder -->
</body>
</html>`;
}

function generateWidgetHTML(widget: Widget): string {
  switch (widget.type) {
    case 'Text':
      return generateTextHTML(widget);
    case 'Input':
      return generateInputHTML(widget);
    case 'Button':
      return generateButtonHTML(widget);
    case 'Image':
      return generateImageHTML(widget);
    case 'Table':
      return generateTableHTML(widget);
    case 'Select':
      return generateSelectHTML(widget);
    default:
      return '';
  }
}

function generateTextHTML(widget: TextWidget): string {
  const { content, fontSize, color, fontWeight, textAlign } = widget.props;
  const { x, y } = widget.position;
  const { width, height } = widget.size;

  return `<div class="widget" style="
  position: absolute;
  left: ${x}px;
  top: ${y}px;
  width: ${width}px;
  height: ${height}px;
  font-size: ${fontSize}px;
  color: ${color};
  font-weight: ${fontWeight};
  text-align: ${textAlign};
">
  ${escapeHTML(content)}
</div>`;
}

// 他のWidget用の生成関数も同様に実装...

function escapeHTML(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
```

---

## API エンドポイント

### GET /api/export/[id]

プロジェクトIDを受け取り、生成されたHTMLファイルを返します。

**レスポンス:**
- Content-Type: `text/html`
- Content-Disposition: `attachment; filename="project-name.html"`

**実装例 (app/api/export/[id]/route.ts):**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getProjectById } from '@/lib/db/queries';
import { generateHTML } from '@/lib/export/html-generator';

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const project = await getProjectById(params.id);

    if (!project) {
      return NextResponse.json(
        { error: 'Project not found' },
        { status: 404 }
      );
    }

    const html = generateHTML(project.name, project.canvasData);
    const filename = `${slugify(project.name)}.html`;

    return new NextResponse(html, {
      headers: {
        'Content-Type': 'text/html; charset=utf-8',
        'Content-Disposition': `attachment; filename="${filename}"`,
      },
    });
  } catch (error) {
    console.error('Failed to export project:', error);
    return NextResponse.json(
      { error: 'Failed to export project' },
      { status: 500 }
    );
  }
}

function slugify(text: string): string {
  return text
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^\w-]+/g, '');
}
```

---

## フロントエンドでのエクスポート処理

### Builder画面でのエクスポートボタン

```typescript
// components/builder/Toolbar.tsx
async function handleExport(projectId: string) {
  try {
    const response = await fetch(`/api/export/${projectId}`);

    if (!response.ok) {
      throw new Error('Export failed');
    }

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `project-${projectId}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export project');
  }
}
```

---

## エクスポート品質

### サニタイゼーション
- ユーザー入力値（テキスト、URL等）はすべてHTMLエスケープ処理
- XSS攻撃対策として必須

### ブラウザ互換性
- モダンブラウザ（Chrome、Firefox、Safari、Edge）で動作
- Internet Explorer は非対応

### アクセシビリティ
- `alt` 属性の適切な設定
- セマンティックHTML（将来的）
- ARIA属性（将来的）

---

## 将来的な拡張（スコープ外）

### 1. 分離型エクスポート（HTML + CSS）

```
project-name/
├── index.html
└── styles.css
```

### 2. JavaScript動作の追加
- ボタンのクリックイベント
- フォームバリデーション
- インタラクティブな動作

### 3. レスポンシブ対応
- メディアクエリの生成
- Flexbox/Grid レイアウト

### 4. エクスポート形式のバリエーション
- React Component
- Vue Component
- Tailwind CSS版
- Bootstrap版

### 5. ZIP形式での複数ファイルエクスポート
- 画像ファイルの同梱
- JSファイルの分離

---

## テスト戦略

### 単体テスト（lib/export/html-generator.test.ts）

```typescript
import { generateHTML } from './html-generator';

describe('HTML Generator', () => {
  it('should generate valid HTML for Text widget', () => {
    const canvasData = {
      components: [{
        id: 'text-1',
        type: 'Text',
        position: { x: 100, y: 50 },
        size: { width: 200, height: 30 },
        props: {
          content: 'Hello World',
          fontSize: 24,
          color: '#000000',
          fontWeight: 'bold',
          textAlign: 'center'
        }
      }]
    };

    const html = generateHTML('Test Project', canvasData);

    expect(html).toContain('<!DOCTYPE html>');
    expect(html).toContain('Hello World');
    expect(html).toContain('font-size: 24px');
  });

  it('should escape HTML in user content', () => {
    const canvasData = {
      components: [{
        id: 'text-1',
        type: 'Text',
        position: { x: 0, y: 0 },
        size: { width: 100, height: 30 },
        props: {
          content: '<script>alert("XSS")</script>',
          fontSize: 16,
          color: '#000000',
          fontWeight: 'normal',
          textAlign: 'left'
        }
      }]
    };

    const html = generateHTML('Test', canvasData);

    expect(html).not.toContain('<script>');
    expect(html).toContain('&lt;script&gt;');
  });
});
```

### 統合テスト
- 実際のプロジェクトデータでのエクスポート
- 生成されたHTMLのバリデーション（W3C Validator）
- 各ブラウザでの表示確認
