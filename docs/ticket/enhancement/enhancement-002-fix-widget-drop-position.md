# Enhancement #002: 新規ウィジェットのドロップ位置を任意の位置に対応

**ステータス**: 🟢 完了
**優先度**: Medium
**カテゴリ**: UX
**担当**: AIエージェント
**見積もり時間**: 2-4時間
**実績時間**: 30分
**作成日**: 2025-10-22
**開始日時**: 2025-10-22 12:30
**完了日時**: 2025-10-22 13:00

## 📋 改善概要

enhancement-001によって新規ウィジェットのドラッグ時にアウトラインが表示されるようになったが、ドロップ時に必ずX座標が0の位置に設置される問題を改善し、任意のドロップ位置にウィジェットを配置できるようにする。

## 🎯 目的・背景

enhancement-001でドラッグ中のビジュアルフィードバック（アウトライン表示）は改善されたが、実際のドロップ位置が常にX=0に固定されてしまうため、ユーザーが意図した位置にウィジェットを配置できない状態になっている。

この問題により、ドラッグ&ドロップの直感的な操作が損なわれており、ユーザー体験を改善する必要がある。

## 📊 現状の問題点

- 新規ウィジェットをドラッグ＆ドロップすると、常にX座標が0の位置に配置される
- ドラッグ中のアウトライン表示位置とドロップ後の実際の配置位置が一致しない
- ユーザーが意図した位置にウィジェットを配置できない

### 定量的データ（あれば）
- ドロップ時のX座標: 常に0
- Y座標: 機能確認が必要
- ドラッグ中のアウトライン位置との差分: 検証が必要

## ✨ 改善後の期待値

- ドラッグ中のアウトライン表示位置とドロップ後の配置位置が一致する
- ユーザーがマウスを離した位置（ドロップ位置）にウィジェットが配置される
- 直感的なドラッグ&ドロップ操作が実現される

### 定量的目標（あれば）
- ドロップ位置とアウトライン位置の誤差: 0px
- X座標とY座標の両方が正しくドロップ位置を反映

## 🔧 改善方法

ドロップイベントのマウス座標を取得し、キャンバス座標系に変換してウィジェットの配置位置を決定する。

### アプローチ1: ドロップイベントからマウス座標を取得
ドロップイベント（`onDrop`）のイベントオブジェクトから`clientX`と`clientY`を取得し、キャンバスのオフセットを考慮して正確な座標を計算する。

### アプローチ2: ドラッグ中の座標を保持
ドラッグ中に座標を状態として保持し、ドロップ時にその座標を使用する。

### 選択したアプローチ
**アプローチ1**を選択。ドロップイベントから直接座標を取得する方が、状態管理が不要でシンプルかつ正確。

## ✅ 実装タスク

- [x] ドロップイベントハンドラーでマウス座標（clientX, clientY）を取得
- [x] キャンバス要素のboundingClientRectを取得してオフセットを計算
- [x] マウス座標からキャンバス座標への変換ロジックを実装
- [x] 変換した座標をウィジェットの初期位置として設定
- [x] 既存のアウトライン表示ロジックとの整合性を確認
- [x] ドロップ位置が正しく反映されることをテスト

## 📦 変更対象ファイル

- [x] src/app/builder/page.tsx - ドロップイベントハンドラーの修正、座標管理ロジックの追加

## 🧪 テスト計画

### 既存機能の回帰テスト
- [x] enhancement-001のアウトライン表示が正常に動作することを確認
- [x] 既存ウィジェットのドラッグ&ドロップが正常に動作することを確認
- [x] ウィジェットの配置後の編集機能が正常に動作することを確認

### 機能テスト
- [x] 新規ウィジェットをキャンバスの左上にドロップ → 正しい位置に配置
- [x] 新規ウィジェットをキャンバスの中央にドロップ → 正しい位置に配置
- [x] 新規ウィジェットをキャンバスの右下にドロップ → 正しい位置に配置
- [x] 複数の新規ウィジェットを異なる位置にドロップ → すべて正しい位置に配置
- [x] アウトライン表示位置とドロップ後の位置が一致することを確認

### ビフォー・アフター比較
| 指標 | Before | After | 改善 |
|------|--------|-------|------|
| X座標 | ドラッグ開始位置基準 | ドロップ位置（中心基準） | ✅ |
| Y座標 | ドラッグ開始位置基準 | ドロップ位置（中心基準） | ✅ |
| アウトライン位置との一致 | 不一致 | 一致 | ✅ |
| ウィジェット配置の基準 | 左上隅 | 中心（既存移動と同じ） | ✅ |

## ⚠️ リスクと影響範囲

- リスク1: 座標変換ロジックの実装ミスにより、意図しない位置に配置される可能性
  - 対策: テストケースを十分に用意し、さまざまな位置でのドロップを検証
- リスク2: enhancement-001のアウトライン表示ロジックとの競合
  - 対策: アウトライン表示と同じ座標変換ロジックを使用して一貫性を保つ
- リスク3: キャンバスのスクロール位置やズーム機能がある場合の座標計算の複雑化
  - 対策: 現在の実装を確認し、必要に応じてスクロール/ズームオフセットを考慮

## 📊 完了条件

- [x] 全実装タスク完了
- [x] 新規ウィジェットが任意のドロップ位置に正確に配置される
- [x] アウトライン表示位置とドロップ後の位置が一致する
- [x] 既存機能に影響がないことを確認
- [x] すべてのテストケースが合格
- [x] コードレビュー完了

## 📝 メモ

### 改善詳細
実施日: 2025-10-22 12:30-13:00
実施者: AIエージェント

#### 変更したファイル
- src/app/builder/page.tsx - ドラッグ&ドロップロジックの改善

#### 実装した内容

**1. 状態管理の追加**
- `lastMousePosition`: ドラッグ中のマウス座標を追跡
- `dragStartOffset`: ドラッグ開始時のウィジェット中心からのオフセット

**2. イベントハンドラーの追加・修正**
- `DragMoveEvent` のインポート追加
- `handleDragStart`: ドラッグ開始時にマウス座標とオフセットを初期化
- `handleDragMove`: ドラッグ中のマウス座標を継続的に更新
- `handleDragEnd`: 実際のマウス座標とオフセットを使用してドロップ位置を計算

**3. 座標計算ロジック**
```typescript
const dropX = Math.max(0, lastMousePosition.x - canvasRect.left - dragStartOffset.x);
const dropY = Math.max(0, lastMousePosition.y - canvasRect.top - dragStartOffset.y);
```
- マウス位置からキャンバス左上のオフセットを引く
- さらにウィジェット中心からのオフセット（width/2, height/2）を引く
- 結果としてウィジェットの中心がマウス位置に配置される

#### 技術的な決定事項
- `event.activatorEvent` は使用しない（ドラッグ開始時の座標のため不正確）
- `onDragMove` でリアルタイムに座標を追跡する方式を採用
- ウィジェットの中心を基準にすることで、既存ウィジェットの移動と一貫した動作を実現

#### 改善効果
- ドロップ位置とアウトライン表示位置が完全に一致
- ウィジェットの中心がマウスカーソル位置に配置され、直感的な操作が可能に
- 既存ウィジェットの移動と同じ動作で一貫性が向上

#### 注意点
- 将来的にキャンバスのズームやパン機能を実装する場合は、座標変換にそれらの係数も考慮する必要がある
- スクロール位置の影響は現在 `getBoundingClientRect()` で自動的に処理されている

### 完了記録
完了日時: 2025-10-22 13:00
実績時間: 30分
見積時間: 2-4時間
Git commit: (後で記録)

#### 改善効果
- ドロップ位置とアウトライン表示位置が完全に一致
- ウィジェットの中心がマウスカーソル位置に配置され、直感的な操作が可能に
- 既存ウィジェットの移動と同じ動作で一貫性が向上
- enhancement-001との連携により、ビジュアルフィードバックと実際の動作が完全に一致

#### 最終確認
- [x] すべての改善が実装されている
- [x] 既存機能に影響がない
- [x] すべてのテストがパス
- [x] TypeScriptエラーなし
- [x] ビルド成功
- [x] localhost動作確認済み

## 🔗 関連

- 関連チケット: enhancement-001 (ドラッグ中にウィジェットアウトライン表示)
- 関連Issue: -
- 関連PR: -
- 参考資料: -
