# Enhancement #002: 新規ウィジェットのドロップ位置を任意の位置に対応

**ステータス**: 🔴 未着手
**優先度**: Medium
**カテゴリ**: UX
**担当**: 未割当
**見積もり時間**: 2-4時間
**実績時間**: -
**作成日**: 2025-10-22
**完了日**: -

## 📋 改善概要

enhancement-001によって新規ウィジェットのドラッグ時にアウトラインが表示されるようになったが、ドロップ時に必ずX座標が0の位置に設置される問題を改善し、任意のドロップ位置にウィジェットを配置できるようにする。

## 🎯 目的・背景

enhancement-001でドラッグ中のビジュアルフィードバック（アウトライン表示）は改善されたが、実際のドロップ位置が常にX=0に固定されてしまうため、ユーザーが意図した位置にウィジェットを配置できない状態になっている。

この問題により、ドラッグ&ドロップの直感的な操作が損なわれており、ユーザー体験を改善する必要がある。

## 📊 現状の問題点

- 新規ウィジェットをドラッグ＆ドロップすると、常にX座標が0の位置に配置される
- ドラッグ中のアウトライン表示位置とドロップ後の実際の配置位置が一致しない
- ユーザーが意図した位置にウィジェットを配置できない

### 定量的データ（あれば）
- ドロップ時のX座標: 常に0
- Y座標: 機能確認が必要
- ドラッグ中のアウトライン位置との差分: 検証が必要

## ✨ 改善後の期待値

- ドラッグ中のアウトライン表示位置とドロップ後の配置位置が一致する
- ユーザーがマウスを離した位置（ドロップ位置）にウィジェットが配置される
- 直感的なドラッグ&ドロップ操作が実現される

### 定量的目標（あれば）
- ドロップ位置とアウトライン位置の誤差: 0px
- X座標とY座標の両方が正しくドロップ位置を反映

## 🔧 改善方法

ドロップイベントのマウス座標を取得し、キャンバス座標系に変換してウィジェットの配置位置を決定する。

### アプローチ1: ドロップイベントからマウス座標を取得
ドロップイベント（`onDrop`）のイベントオブジェクトから`clientX`と`clientY`を取得し、キャンバスのオフセットを考慮して正確な座標を計算する。

### アプローチ2: ドラッグ中の座標を保持
ドラッグ中に座標を状態として保持し、ドロップ時にその座標を使用する。

### 選択したアプローチ
**アプローチ1**を選択。ドロップイベントから直接座標を取得する方が、状態管理が不要でシンプルかつ正確。

## ✅ 実装タスク

- [ ] ドロップイベントハンドラーでマウス座標（clientX, clientY）を取得
- [ ] キャンバス要素のboundingClientRectを取得してオフセットを計算
- [ ] マウス座標からキャンバス座標への変換ロジックを実装
- [ ] 変換した座標をウィジェットの初期位置として設定
- [ ] 既存のアウトライン表示ロジックとの整合性を確認
- [ ] ドロップ位置が正しく反映されることをテスト

## 📦 変更対象ファイル

- [ ] 関連コンポーネントファイル - ドロップイベントハンドラーの修正（ファイル特定が必要）
- [ ] 座標変換ロジックの追加または修正

## 🧪 テスト計画

### 既存機能の回帰テスト
- [ ] enhancement-001のアウトライン表示が正常に動作することを確認
- [ ] 既存ウィジェットのドラッグ&ドロップが正常に動作することを確認
- [ ] ウィジェットの配置後の編集機能が正常に動作することを確認

### 機能テスト
- [ ] 新規ウィジェットをキャンバスの左上にドロップ → 正しい位置に配置
- [ ] 新規ウィジェットをキャンバスの中央にドロップ → 正しい位置に配置
- [ ] 新規ウィジェットをキャンバスの右下にドロップ → 正しい位置に配置
- [ ] 複数の新規ウィジェットを異なる位置にドロップ → すべて正しい位置に配置
- [ ] アウトライン表示位置とドロップ後の位置が一致することを確認

### ビフォー・アフター比較
| 指標 | Before | After | 改善 |
|------|--------|-------|------|
| X座標 | 常に0 | ドロップ位置 | ✅ |
| Y座標 | 要確認 | ドロップ位置 | 要確認 |
| アウトライン位置との一致 | 不一致 | 一致 | ✅ |

## ⚠️ リスクと影響範囲

- リスク1: 座標変換ロジックの実装ミスにより、意図しない位置に配置される可能性
  - 対策: テストケースを十分に用意し、さまざまな位置でのドロップを検証
- リスク2: enhancement-001のアウトライン表示ロジックとの競合
  - 対策: アウトライン表示と同じ座標変換ロジックを使用して一貫性を保つ
- リスク3: キャンバスのスクロール位置やズーム機能がある場合の座標計算の複雑化
  - 対策: 現在の実装を確認し、必要に応じてスクロール/ズームオフセットを考慮

## 📊 完了条件

- [ ] 全実装タスク完了
- [ ] 新規ウィジェットが任意のドロップ位置に正確に配置される
- [ ] アウトライン表示位置とドロップ後の位置が一致する
- [ ] 既存機能に影響がないことを確認
- [ ] すべてのテストケースが合格
- [ ] コードレビュー完了

## 📝 メモ

- enhancement-001の実装内容を確認し、アウトライン表示に使用している座標計算ロジックを参照する
- ドロップイベントの座標取得時は、キャンバスの境界とオフセットを正確に計算する必要がある
- 将来的にキャンバスのズームやパン機能を実装する場合は、それらの変換も考慮する設計にする

## 🔗 関連

- 関連チケット: enhancement-001 (ドラッグ中にウィジェットアウトライン表示)
- 関連Issue: -
- 関連PR: -
- 参考資料: -
