# Bug #003: ウィジェットの幅・高さを0にするとcanvas上にオブジェクトが残る

**ステータス**: 🟢 完了
**優先度**: Medium
**担当**: AIエージェント
**作成日**: 2025-10-22
**開始日時**: 2025-10-22
**完了日時**: 2025-10-22
**実績時間**: 約30分

## 🐛 バグ概要

ウィジェットのプロパティで幅（width）と高さ（height）を0に設定した場合、canvas上からビジュアルとしては見えなくなるが、オブジェクトとしてはcanvas上に残ってしまう問題。

## 📍 発生環境

- ブラウザ: 未確認
- OS: 未確認
- URL: /builder
- バージョン: -

## 🔄 再現手順

1. ビルダーページでウィジェットを配置する
2. 配置したウィジェットを選択する
3. プロパティパネルでwidthを0に設定する
4. プロパティパネルでheightを0に設定する
5. canvas上を確認する

## ❌ 期待される動作

幅・高さが0のウィジェットは、実質的に存在しないものとして扱われるべき。以下のいずれかの動作が期待される：
- ウィジェットが自動的に削除される
- 最小サイズ制限を設ける（例：最小10px）
- 警告を表示してサイズ変更を防ぐ

## 🚨 実際の動作

幅・高さを0に設定すると、視覚的には見えなくなるが、内部的にはcanvas上にオブジェクトとして残り続ける。これにより以下の問題が発生する可能性：
- 不可視のウィジェットが選択できずに管理できない
- メモリリークやパフォーマンス低下の原因になる
- HTMLエクスポート時に不要な要素が含まれる

## 📸 スクリーンショット/ログ

未添付

## 🔍 原因分析

### 問題箇所
1. [PropertiesPanel.tsx:68-79](src/components/builder/PropertiesPanel.tsx#L68-L79)
   - NumberInputコンポーネントのmin属性は警告表示のみで、実際の入力を阻止できない
   - ユーザーが手入力で0や負の値を入力可能

2. [page.tsx:180-187](src/app/builder/page.tsx#L180-L187)
   - updateWidget関数にサイズバリデーションが一切存在しない
   - 幅・高さ0のウィジェットがcanvas上に残り続ける

### 根本原因
- フロントエンド（PropertiesPanel）とバックエンド（updateWidget）の両方でサイズバリデーションが欠如
- 最小サイズ制約の未実装
- HTML標準の`<input type="number" min="...">`属性は入力を強制できない

## ✅ 修正内容

- [x] 修正コミット: 131e50c456c0985c9b03512f670bba291d56e5c0
- [x] 影響範囲: PropertiesPanel.tsx, page.tsx, widget-utils.ts
- [x] テスト実施: 視覚的動作確認完了、TypeScriptコンパイルチェック完了

### 修正詳細

#### 1. widget-utils.ts - 最小サイズ定義の追加
- ファイル: [src/lib/widget-utils.ts](src/lib/widget-utils.ts#L16-L28)
- 変更内容: `getMinSize()`関数を新規追加
- ウィジェットタイプごとの最小サイズ:
  - Text: 50px × 25px
  - Input: 120px × 60px
  - Button: 80px × 40px
  - Image: 50px × 50px
  - Table: 200px × 120px
  - Select: 120px × 60px

#### 2. PropertiesPanel.tsx - 入力時バリデーション
- ファイル: [src/components/builder/PropertiesPanel.tsx](src/components/builder/PropertiesPanel.tsx#L72-L90)
- 変更内容: 幅・高さ入力時に`Math.max(minSize, value)`でバリデーション
- 理由: ユーザーが0を入力しても、即座に最小値にリセットされる

#### 3. page.tsx - updateWidget関数のバリデーション
- ファイル: [src/app/builder/page.tsx](src/app/builder/page.tsx#L180-L203)
- 変更内容: サイズ更新時に最小値チェックを追加
- 理由: どこからサイズが更新されても安全性を保証（二重の防御）

## 🧪 テスト確認項目

- [x] 幅・高さを0に設定した場合の適切な処理を確認
  - 結果: 最小値に自動修正されることを確認
- [x] 最小サイズ制限が機能することを確認
  - 結果: ウィジェットタイプごとの最小サイズが正しく適用される
- [x] 既存ウィジェットのリサイズ機能に影響がないことを確認
  - 結果: 既存機能に影響なし
- [x] HTMLエクスポート時に不正な要素が含まれないことを確認
  - 結果: サイズ0のウィジェットが生成されないため、エクスポートも正常

## 📝 メモ

修正実施日: 2025-10-22
修正者: AIエージェント

### 採用した修正方針
最小サイズ制限（ウィジェットタイプごとに最適化）を実装

### 実装のポイント
1. 二重のバリデーション（フロントエンド + バックエンド）で安全性を確保
2. ウィジェットタイプごとに適切な最小サイズを定義
3. ユーザーが0を入力しても即座に最小値に戻るため、直感的
4. 既存コードへの影響を最小限に抑えた修正

### 完了記録
完了日時: 2025-10-22
実績時間: 約30分
Git commit: 131e50c456c0985c9b03512f670bba291d56e5c0

#### 最終確認
- [x] バグが完全に修正されている
- [x] 関連機能に影響がない
- [x] テストがすべてパス
- [x] TypeScriptエラーなし

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 参考資料: -
