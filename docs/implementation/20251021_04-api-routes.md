# API Routes実装ガイド

## 目次
1. [Next.js 14 App Router API概要](#nextjs-14-app-router-api概要)
2. [RESTful API設計原則](#restful-api設計原則)
3. [エンドポイント実装](#エンドポイント実装)
4. [リクエスト/レスポンス型定義](#リクエストレスポンス型定義)
5. [エラーハンドリングパターン](#エラーハンドリングパターン)
6. [HTTPステータスコード使用規約](#httpステータスコード使用規約)
7. [バリデーション実装](#バリデーション実装)
8. [セキュリティ考慮事項](#セキュリティ考慮事項)
9. [APIテスト方法](#apiテスト方法)

---

## Next.js 14 App Router API概要

### App Router APIの特徴

Next.js 14のApp Routerでは、`route.ts`ファイルを使用してAPIエンドポイントを定義します。

#### 従来のPages Router との違い

| 項目 | Pages Router | App Router |
|------|-------------|------------|
| ファイル名 | `api/projects.ts` | `api/projects/route.ts` |
| エクスポート | `export default function handler` | `export async function GET/POST` |
| 型定義 | `NextApiRequest`, `NextApiResponse` | `NextRequest`, `NextResponse` |
| ミドルウェア | 手動実装 | ビルトイン機能 |
| ストリーミング | 限定的 | 完全サポート |

#### App Router APIの利点

1. **HTTPメソッドごとの関数定義**
   - `GET`, `POST`, `PUT`, `DELETE`ごとに関数を分離
   - 可読性とメンテナンス性の向上

2. **Web標準APIの採用**
   - `Request`と`Response`オブジェクトを使用
   - ブラウザAPIとの一貫性

3. **ストリーミング対応**
   - Server-Sent Events (SSE)
   - ストリーミングレスポンス

4. **Edge Runtime対応**
   - Vercel Edge Functionsで実行可能
   - 低レイテンシー、グローバル展開

### ファイル構造

```
src/app/api/
├── projects/
│   ├── route.ts              # GET, POST /api/projects
│   └── [id]/
│       └── route.ts          # GET, PUT, DELETE /api/projects/[id]
└── export/
    └── [id]/
        └── route.ts          # GET /api/export/[id]
```

---

## RESTful API設計原則

### REST原則の適用

#### 1. **リソース中心の設計**

リソース（Project）を中心にエンドポイントを設計します。

- **良い例**: `/api/projects`
- **悪い例**: `/api/getProjects`, `/api/createProject`

#### 2. **HTTPメソッドの適切な使用**

| メソッド | 操作 | 冪等性 | 安全性 |
|---------|------|-------|-------|
| GET | 取得 | ○ | ○ |
| POST | 作成 | × | × |
| PUT | 更新 | ○ | × |
| DELETE | 削除 | ○ | × |

#### 3. **ステータスコードの一貫性**

- `200 OK`: 成功（GET, PUT）
- `201 Created`: 作成成功（POST）
- `204 No Content`: 成功、レスポンスボディなし（DELETE）
- `400 Bad Request`: クライアントエラー
- `404 Not Found`: リソースが見つからない
- `500 Internal Server Error`: サーバーエラー

#### 4. **JSONフォーマットの統一**

**成功レスポンス:**
```json
{
  "project": { ... },
  "message": "Success message"
}
```

**エラーレスポンス:**
```json
{
  "error": "Error message",
  "details": { ... }
}
```

---

## エンドポイント実装

### エンドポイント一覧

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/projects` | プロジェクト一覧取得 |
| POST | `/api/projects` | プロジェクト作成 |
| GET | `/api/projects/[id]` | プロジェクト詳細取得 |
| PUT | `/api/projects/[id]` | プロジェクト更新 |
| DELETE | `/api/projects/[id]` | プロジェクト削除 |
| GET | `/api/export/[id]` | HTML/CSSエクスポート |

---

### 1. プロジェクト一覧・作成API

**ファイル: `src/app/api/projects/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getRecentProjects, createProject } from '@/lib/db/queries';
import { z } from 'zod';

/**
 * プロジェクト作成時のバリデーションスキーマ
 */
const createProjectSchema = z.object({
  name: z
    .string()
    .min(1, 'プロジェクト名は必須です')
    .max(255, 'プロジェクト名は255文字以内で入力してください'),
  description: z.string().optional(),
  canvasData: z
    .object({
      components: z.array(z.any()),
      settings: z.object({}).optional(),
    })
    .optional(),
});

/**
 * GET /api/projects
 *
 * プロジェクト一覧を取得します。
 *
 * Query Parameters:
 * - limit: 取得件数（デフォルト: 10）
 *
 * @example
 * fetch('/api/projects?limit=20')
 */
export async function GET(request: NextRequest) {
  try {
    // クエリパラメータの取得
    const searchParams = request.nextUrl.searchParams;
    const limitParam = searchParams.get('limit');
    const limit = limitParam ? parseInt(limitParam, 10) : 10;

    // バリデーション: limitは1〜100の範囲
    if (limit < 1 || limit > 100) {
      return NextResponse.json(
        {
          error: 'limitは1から100の間で指定してください',
        },
        { status: 400 }
      );
    }

    // データベースからプロジェクト取得
    const projects = await getRecentProjects(limit);

    return NextResponse.json(
      {
        projects,
        count: projects.length,
      },
      { status: 200 }
    );
  } catch (error) {
    console.error('Failed to fetch projects:', error);

    return NextResponse.json(
      {
        error: 'プロジェクト一覧の取得に失敗しました',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}

/**
 * POST /api/projects
 *
 * 新しいプロジェクトを作成します。
 *
 * Request Body:
 * {
 *   "name": "Project Name",
 *   "description": "Project Description",
 *   "canvasData": { "components": [] }
 * }
 *
 * @example
 * fetch('/api/projects', {
 *   method: 'POST',
 *   headers: { 'Content-Type': 'application/json' },
 *   body: JSON.stringify({ name: 'My Project' })
 * })
 */
export async function POST(request: NextRequest) {
  try {
    // リクエストボディの取得
    let body;
    try {
      body = await request.json();
    } catch {
      return NextResponse.json(
        {
          error: '無効なJSONフォーマットです',
        },
        { status: 400 }
      );
    }

    // バリデーション
    const validationResult = createProjectSchema.safeParse(body);

    if (!validationResult.success) {
      return NextResponse.json(
        {
          error: 'バリデーションエラー',
          details: validationResult.error.errors.map((err) => ({
            field: err.path.join('.'),
            message: err.message,
          })),
        },
        { status: 400 }
      );
    }

    const { name, description, canvasData } = validationResult.data;

    // プロジェクト作成
    const project = await createProject({
      name,
      description,
      canvasData: canvasData || { components: [] },
    });

    return NextResponse.json(
      {
        project,
        message: 'プロジェクトを作成しました',
      },
      { status: 201 }
    );
  } catch (error) {
    console.error('Failed to create project:', error);

    return NextResponse.json(
      {
        error: 'プロジェクトの作成に失敗しました',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}
```

---

### 2. プロジェクト詳細・更新・削除API

**ファイル: `src/app/api/projects/[id]/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getProjectById, updateProject, deleteProject } from '@/lib/db/queries';
import { z } from 'zod';

/**
 * プロジェクト更新時のバリデーションスキーマ
 */
const updateProjectSchema = z.object({
  name: z
    .string()
    .min(1, 'プロジェクト名は空にできません')
    .max(255, 'プロジェクト名は255文字以内で入力してください')
    .optional(),
  description: z.string().optional(),
  canvasData: z
    .object({
      components: z.array(z.any()),
      settings: z.object({}).optional(),
    })
    .optional(),
});

/**
 * RouteパラメータのContext型定義
 */
type RouteContext = {
  params: {
    id: string;
  };
};

/**
 * UUIDバリデーション
 */
function isValidUUID(id: string): boolean {
  const uuidRegex =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  return uuidRegex.test(id);
}

/**
 * GET /api/projects/[id]
 *
 * 指定されたIDのプロジェクトを取得します。
 *
 * @example
 * fetch('/api/projects/550e8400-e29b-41d4-a716-446655440000')
 */
export async function GET(
  request: NextRequest,
  context: RouteContext
) {
  try {
    const { id } = context.params;

    // UUIDバリデーション
    if (!isValidUUID(id)) {
      return NextResponse.json(
        {
          error: '無効なプロジェクトIDです',
        },
        { status: 400 }
      );
    }

    // プロジェクト取得
    const project = await getProjectById(id);

    if (!project) {
      return NextResponse.json(
        {
          error: 'プロジェクトが見つかりません',
        },
        { status: 404 }
      );
    }

    return NextResponse.json(
      {
        project,
      },
      { status: 200 }
    );
  } catch (error) {
    console.error(`Failed to fetch project with id ${context.params.id}:`, error);

    return NextResponse.json(
      {
        error: 'プロジェクトの取得に失敗しました',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}

/**
 * PUT /api/projects/[id]
 *
 * 指定されたIDのプロジェクトを更新します。
 *
 * Request Body:
 * {
 *   "name": "Updated Name",
 *   "description": "Updated Description",
 *   "canvasData": { "components": [...] }
 * }
 *
 * @example
 * fetch('/api/projects/550e8400-e29b-41d4-a716-446655440000', {
 *   method: 'PUT',
 *   headers: { 'Content-Type': 'application/json' },
 *   body: JSON.stringify({ name: 'New Name' })
 * })
 */
export async function PUT(
  request: NextRequest,
  context: RouteContext
) {
  try {
    const { id } = context.params;

    // UUIDバリデーション
    if (!isValidUUID(id)) {
      return NextResponse.json(
        {
          error: '無効なプロジェクトIDです',
        },
        { status: 400 }
      );
    }

    // リクエストボディの取得
    let body;
    try {
      body = await request.json();
    } catch {
      return NextResponse.json(
        {
          error: '無効なJSONフォーマットです',
        },
        { status: 400 }
      );
    }

    // バリデーション
    const validationResult = updateProjectSchema.safeParse(body);

    if (!validationResult.success) {
      return NextResponse.json(
        {
          error: 'バリデーションエラー',
          details: validationResult.error.errors.map((err) => ({
            field: err.path.join('.'),
            message: err.message,
          })),
        },
        { status: 400 }
      );
    }

    const { name, description, canvasData } = validationResult.data;

    // 更新データが空の場合のチェック
    if (!name && !description && !canvasData) {
      return NextResponse.json(
        {
          error: '更新するデータが指定されていません',
        },
        { status: 400 }
      );
    }

    // プロジェクト更新
    const project = await updateProject(id, {
      name,
      description,
      canvasData,
    });

    if (!project) {
      return NextResponse.json(
        {
          error: 'プロジェクトが見つかりません',
        },
        { status: 404 }
      );
    }

    return NextResponse.json(
      {
        project,
        message: 'プロジェクトを更新しました',
      },
      { status: 200 }
    );
  } catch (error) {
    console.error(`Failed to update project with id ${context.params.id}:`, error);

    return NextResponse.json(
      {
        error: 'プロジェクトの更新に失敗しました',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}

/**
 * DELETE /api/projects/[id]
 *
 * 指定されたIDのプロジェクトを削除します。
 *
 * @example
 * fetch('/api/projects/550e8400-e29b-41d4-a716-446655440000', {
 *   method: 'DELETE'
 * })
 */
export async function DELETE(
  request: NextRequest,
  context: RouteContext
) {
  try {
    const { id } = context.params;

    // UUIDバリデーション
    if (!isValidUUID(id)) {
      return NextResponse.json(
        {
          error: '無効なプロジェクトIDです',
        },
        { status: 400 }
      );
    }

    // プロジェクト削除
    const project = await deleteProject(id);

    if (!project) {
      return NextResponse.json(
        {
          error: 'プロジェクトが見つかりません',
        },
        { status: 404 }
      );
    }

    return NextResponse.json(
      {
        message: 'プロジェクトを削除しました',
        deletedProject: {
          id: project.id,
          name: project.name,
        },
      },
      { status: 200 }
    );
  } catch (error) {
    console.error(`Failed to delete project with id ${context.params.id}:`, error);

    return NextResponse.json(
      {
        error: 'プロジェクトの削除に失敗しました',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}
```

---

### 3. HTML/CSSエクスポートAPI

**ファイル: `src/app/api/export/[id]/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getProjectById } from '@/lib/db/queries';
import { generateHTML } from '@/lib/export/html-generator';

/**
 * RouteパラメータのContext型定義
 */
type RouteContext = {
  params: {
    id: string;
  };
};

/**
 * UUIDバリデーション
 */
function isValidUUID(id: string): boolean {
  const uuidRegex =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  return uuidRegex.test(id);
}

/**
 * GET /api/export/[id]
 *
 * 指定されたプロジェクトをHTML/CSSとしてエクスポートします。
 *
 * Query Parameters:
 * - format: エクスポート形式（'html' | 'zip'、デフォルト: 'html'）
 *
 * @example
 * // 単一HTMLファイルとして取得
 * fetch('/api/export/550e8400-e29b-41d4-a716-446655440000?format=html')
 *
 * // ZIPファイルとして取得（将来的）
 * fetch('/api/export/550e8400-e29b-41d4-a716-446655440000?format=zip')
 */
export async function GET(
  request: NextRequest,
  context: RouteContext
) {
  try {
    const { id } = context.params;

    // UUIDバリデーション
    if (!isValidUUID(id)) {
      return NextResponse.json(
        {
          error: '無効なプロジェクトIDです',
        },
        { status: 400 }
      );
    }

    // クエリパラメータの取得
    const searchParams = request.nextUrl.searchParams;
    const format = searchParams.get('format') || 'html';

    // formatバリデーション
    if (format !== 'html' && format !== 'zip') {
      return NextResponse.json(
        {
          error: 'formatは "html" または "zip" を指定してください',
        },
        { status: 400 }
      );
    }

    // プロジェクト取得
    const project = await getProjectById(id);

    if (!project) {
      return NextResponse.json(
        {
          error: 'プロジェクトが見つかりません',
        },
        { status: 404 }
      );
    }

    // canvas_dataの検証
    if (!project.canvasData || typeof project.canvasData !== 'object') {
      return NextResponse.json(
        {
          error: 'プロジェクトデータが不正です',
        },
        { status: 500 }
      );
    }

    // HTML生成
    const html = generateHTML(project.canvasData, {
      title: project.name,
      description: project.description || undefined,
    });

    // HTMLレスポンスを返す
    return new NextResponse(html, {
      status: 200,
      headers: {
        'Content-Type': 'text/html; charset=utf-8',
        'Content-Disposition': `attachment; filename="${encodeURIComponent(
          project.name
        )}.html"`,
      },
    });
  } catch (error) {
    console.error(`Failed to export project with id ${context.params.id}:`, error);

    return NextResponse.json(
      {
        error: 'プロジェクトのエクスポートに失敗しました',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}
```

**HTML生成ユーティリティ: `src/lib/export/html-generator.ts`**

```typescript
/**
 * Canvas DataからHTMLを生成するユーティリティ
 */

interface CanvasData {
  components: CanvasComponent[];
  settings?: CanvasSettings;
}

interface CanvasComponent {
  id: string;
  type: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  props: Record<string, any>;
}

interface CanvasSettings {
  backgroundColor?: string;
  width?: number;
  height?: number;
}

interface GenerateHTMLOptions {
  title?: string;
  description?: string;
}

/**
 * Canvas DataからHTML文字列を生成
 *
 * @param canvasData - Canvas Data
 * @param options - 生成オプション
 * @returns HTML文字列
 */
export function generateHTML(
  canvasData: CanvasData,
  options: GenerateHTMLOptions = {}
): string {
  const { title = 'NoCode UI Builder - Exported Page', description = '' } = options;
  const { components, settings } = canvasData;

  // CSSスタイルの生成
  const styles = generateCSS(components, settings);

  // HTMLボディの生成
  const bodyHTML = components
    .map((component) => generateComponentHTML(component))
    .join('\n');

  // 完全なHTMLドキュメント
  return `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="${escapeHTML(description)}">
  <title>${escapeHTML(title)}</title>
  <style>
${styles}
  </style>
</head>
<body>
  <div class="canvas-container">
${bodyHTML}
  </div>
</body>
</html>`;
}

/**
 * CSSスタイルの生成
 */
function generateCSS(
  components: CanvasComponent[],
  settings?: CanvasSettings
): string {
  const backgroundColor = settings?.backgroundColor || '#ffffff';
  const canvasWidth = settings?.width || 1200;
  const canvasHeight = settings?.height || 800;

  let css = `
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f3f4f6;
    }

    .canvas-container {
      position: relative;
      width: ${canvasWidth}px;
      height: ${canvasHeight}px;
      margin: 0 auto;
      background-color: ${backgroundColor};
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .widget {
      position: absolute;
    }
  `;

  // 各コンポーネントのスタイル
  components.forEach((component) => {
    css += `\n${generateComponentCSS(component)}\n`;
  });

  return css;
}

/**
 * コンポーネントのHTML生成
 */
function generateComponentHTML(component: CanvasComponent): string {
  const { id, type, props } = component;

  switch (type) {
    case 'Text':
      return `    <div id="${id}" class="widget widget-text">${escapeHTML(
        props.content || ''
      )}</div>`;

    case 'Button':
      return `    <button id="${id}" class="widget widget-button">${escapeHTML(
        props.text || 'Button'
      )}</button>`;

    case 'Input':
      return `    <div id="${id}" class="widget widget-input">
      <label>${escapeHTML(props.label || '')}</label>
      <input type="${props.inputType || 'text'}" placeholder="${escapeHTML(
        props.placeholder || ''
      )}" ${props.required ? 'required' : ''}>
    </div>`;

    case 'Image':
      return `    <img id="${id}" class="widget widget-image" src="${escapeHTML(
        props.src || ''
      )}" alt="${escapeHTML(props.alt || '')}">`;

    case 'Table':
      return generateTableHTML(id, props);

    case 'Select':
      return generateSelectHTML(id, props);

    default:
      return `    <div id="${id}" class="widget">Unsupported widget: ${type}</div>`;
  }
}

/**
 * コンポーネントのCSS生成
 */
function generateComponentCSS(component: CanvasComponent): string {
  const { id, type, position, size, props } = component;

  let css = `    #${id} {
      left: ${position.x}px;
      top: ${position.y}px;
      width: ${size.width}px;
      height: ${size.height}px;`;

  switch (type) {
    case 'Text':
      css += `
      font-size: ${props.fontSize || 16}px;
      color: ${props.color || '#000000'};
      font-weight: ${props.fontWeight || 'normal'};
      text-align: ${props.textAlign || 'left'};
      line-height: ${size.height}px;`;
      break;

    case 'Button':
      css += `
      background-color: ${props.color || '#3B82F6'};
      color: ${props.textColor || '#FFFFFF'};
      border: none;
      border-radius: ${props.borderRadius || 4}px;
      font-size: ${props.fontSize || 16}px;
      cursor: pointer;
      transition: background-color 0.2s;`;
      break;

    case 'Input':
      css += `
      display: flex;
      flex-direction: column;
      gap: 8px;`;
      break;

    case 'Image':
      css += `
      object-fit: ${props.objectFit || 'cover'};`;
      break;
  }

  css += `
    }`;

  return css;
}

/**
 * テーブルHTML生成
 */
function generateTableHTML(id: string, props: any): string {
  const columns = props.columns || [];
  const data = props.data || [];

  const headerHTML = columns
    .map((col: any) => `<th>${escapeHTML(col.label || col.key)}</th>`)
    .join('');

  const rowsHTML = data
    .map(
      (row: any) =>
        `<tr>${columns
          .map((col: any) => `<td>${escapeHTML(String(row[col.key] || ''))}</td>`)
          .join('')}</tr>`
    )
    .join('\n        ');

  return `    <div id="${id}" class="widget widget-table">
      <table>
        <thead>
          <tr>${headerHTML}</tr>
        </thead>
        <tbody>
        ${rowsHTML}
        </tbody>
      </table>
    </div>`;
}

/**
 * セレクトHTML生成
 */
function generateSelectHTML(id: string, props: any): string {
  const options = props.options || [];
  const optionsHTML = options
    .map(
      (opt: any) =>
        `<option value="${escapeHTML(opt.value)}">${escapeHTML(
          opt.label || opt.value
        )}</option>`
    )
    .join('\n        ');

  return `    <div id="${id}" class="widget widget-select">
      <label>${escapeHTML(props.label || '')}</label>
      <select>
        ${optionsHTML}
      </select>
    </div>`;
}

/**
 * HTMLエスケープ
 */
function escapeHTML(str: string): string {
  const div = { innerHTML: '' } as any;
  const text = document.createTextNode(str);
  div.appendChild(text);
  return div.innerHTML;
}
```

---

## リクエスト/レスポンス型定義

### 型定義ファイル: `src/types/api.ts`

```typescript
/**
 * API型定義
 */

import { Project } from '@/lib/db/schema';

/**
 * API成功レスポンスの基本型
 */
export interface ApiSuccessResponse<T = any> {
  data?: T;
  message?: string;
}

/**
 * APIエラーレスポンスの型
 */
export interface ApiErrorResponse {
  error: string;
  details?: any;
}

/**
 * プロジェクト一覧取得レスポンス
 */
export interface GetProjectsResponse {
  projects: Project[];
  count: number;
}

/**
 * プロジェクト作成リクエスト
 */
export interface CreateProjectRequest {
  name: string;
  description?: string;
  canvasData?: {
    components: any[];
    settings?: Record<string, any>;
  };
}

/**
 * プロジェクト作成レスポンス
 */
export interface CreateProjectResponse {
  project: Project;
  message: string;
}

/**
 * プロジェクト取得レスポンス
 */
export interface GetProjectResponse {
  project: Project;
}

/**
 * プロジェクト更新リクエスト
 */
export interface UpdateProjectRequest {
  name?: string;
  description?: string;
  canvasData?: {
    components: any[];
    settings?: Record<string, any>;
  };
}

/**
 * プロジェクト更新レスポンス
 */
export interface UpdateProjectResponse {
  project: Project;
  message: string;
}

/**
 * プロジェクト削除レスポンス
 */
export interface DeleteProjectResponse {
  message: string;
  deletedProject: {
    id: string;
    name: string;
  };
}
```

---

## エラーハンドリングパターン

### 統一的なエラーハンドリング

すべてのAPIエンドポイントで一貫したエラーハンドリングを実装します。

#### エラーハンドリングユーティリティ: `src/lib/api/error-handler.ts`

```typescript
import { NextResponse } from 'next/server';
import { ZodError } from 'zod';

/**
 * APIエラーハンドラー
 *
 * さまざまなエラータイプを統一的に処理し、適切なレスポンスを返します。
 */
export function handleApiError(error: unknown): NextResponse {
  console.error('API Error:', error);

  // Zodバリデーションエラー
  if (error instanceof ZodError) {
    return NextResponse.json(
      {
        error: 'バリデーションエラー',
        details: error.errors.map((err) => ({
          field: err.path.join('.'),
          message: err.message,
        })),
      },
      { status: 400 }
    );
  }

  // カスタムエラー（メッセージ付き）
  if (error instanceof Error) {
    // データベースエラー
    if (error.message.includes('database') || error.message.includes('query')) {
      return NextResponse.json(
        {
          error: 'データベースエラーが発生しました',
          details: process.env.NODE_ENV === 'development' ? error.message : undefined,
        },
        { status: 500 }
      );
    }

    // その他のエラー
    return NextResponse.json(
      {
        error: error.message,
        details: process.env.NODE_ENV === 'development' ? error.stack : undefined,
      },
      { status: 500 }
    );
  }

  // 不明なエラー
  return NextResponse.json(
    {
      error: '予期しないエラーが発生しました',
    },
    { status: 500 }
  );
}

/**
 * カスタムエラークラス
 */
export class ApiError extends Error {
  constructor(
    public message: string,
    public statusCode: number = 500,
    public details?: any
  ) {
    super(message);
    this.name = 'ApiError';
  }
}

/**
 * NotFoundエラー
 */
export class NotFoundError extends ApiError {
  constructor(resource: string = 'Resource') {
    super(`${resource}が見つかりません`, 404);
    this.name = 'NotFoundError';
  }
}

/**
 * BadRequestエラー
 */
export class BadRequestError extends ApiError {
  constructor(message: string = '無効なリクエストです', details?: any) {
    super(message, 400, details);
    this.name = 'BadRequestError';
  }
}

/**
 * UnauthorizedError
 */
export class UnauthorizedError extends ApiError {
  constructor(message: string = '認証が必要です') {
    super(message, 401);
    this.name = 'UnauthorizedError';
  }
}
```

---

## HTTPステータスコード使用規約

### ステータスコード一覧

| コード | 名称 | 使用場面 |
|-------|------|---------|
| **2xx: 成功** |
| 200 | OK | GET, PUT成功 |
| 201 | Created | POST成功（リソース作成） |
| 204 | No Content | DELETE成功（レスポンスボディなし） |
| **4xx: クライアントエラー** |
| 400 | Bad Request | バリデーションエラー、不正なリクエスト |
| 401 | Unauthorized | 認証が必要 |
| 403 | Forbidden | アクセス権限なし |
| 404 | Not Found | リソースが見つからない |
| 409 | Conflict | リソースの競合 |
| 422 | Unprocessable Entity | セマンティックエラー |
| **5xx: サーバーエラー** |
| 500 | Internal Server Error | サーバー内部エラー |
| 503 | Service Unavailable | サービス一時停止 |

### 使用例

```typescript
// 200 OK: 取得成功
return NextResponse.json({ project }, { status: 200 });

// 201 Created: 作成成功
return NextResponse.json({ project, message: '作成しました' }, { status: 201 });

// 400 Bad Request: バリデーションエラー
return NextResponse.json({ error: 'バリデーションエラー' }, { status: 400 });

// 404 Not Found: リソースなし
return NextResponse.json({ error: 'プロジェクトが見つかりません' }, { status: 404 });

// 500 Internal Server Error: サーバーエラー
return NextResponse.json({ error: 'サーバーエラー' }, { status: 500 });
```

---

## バリデーション実装

### Zodを使用したバリデーション

#### インストール

```bash
npm install zod
```

#### バリデーションスキーマ: `src/lib/validation/schemas.ts`

```typescript
import { z } from 'zod';

/**
 * プロジェクト作成バリデーション
 */
export const createProjectSchema = z.object({
  name: z
    .string({
      required_error: 'プロジェクト名は必須です',
      invalid_type_error: 'プロジェクト名は文字列である必要があります',
    })
    .min(1, 'プロジェクト名は1文字以上で入力してください')
    .max(255, 'プロジェクト名は255文字以内で入力してください')
    .trim(),

  description: z
    .string()
    .max(1000, '説明は1000文字以内で入力してください')
    .trim()
    .optional(),

  canvasData: z
    .object({
      components: z.array(
        z.object({
          id: z.string().uuid('コンポーネントIDは有効なUUIDである必要があります'),
          type: z.enum(['Text', 'Button', 'Input', 'Image', 'Table', 'Select']),
          position: z.object({
            x: z.number().min(0),
            y: z.number().min(0),
          }),
          size: z.object({
            width: z.number().positive(),
            height: z.number().positive(),
          }),
          props: z.record(z.any()),
        })
      ),
      settings: z.record(z.any()).optional(),
    })
    .optional(),
});

/**
 * プロジェクト更新バリデーション
 */
export const updateProjectSchema = createProjectSchema.partial();

/**
 * UUID検証
 */
export const uuidSchema = z.string().uuid('無効なUUID形式です');

/**
 * ページネーションパラメータ検証
 */
export const paginationSchema = z.object({
  limit: z.coerce.number().int().min(1).max(100).default(10),
  offset: z.coerce.number().int().min(0).default(0),
});
```

---

## セキュリティ考慮事項

### 1. XSS (Cross-Site Scripting) 対策

#### 入力のサニタイゼーション

```typescript
import DOMPurify from 'isomorphic-dompurify';

// HTMLのサニタイゼーション
const sanitizedContent = DOMPurify.sanitize(userInput);
```

#### Content Security Policy (CSP) の設定

`next.config.js`:

```javascript
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' data: https:",
      "font-src 'self'",
      "connect-src 'self'",
    ].join('; '),
  },
];

module.exports = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ];
  },
};
```

### 2. CSRF (Cross-Site Request Forgery) 対策

Next.js 14では、SameSite Cookieがデフォルトで有効になっています。

#### 追加の対策（認証実装時）

```typescript
// CSRFトークンの検証
import { verifyCSRFToken } from '@/lib/security/csrf';

export async function POST(request: NextRequest) {
  const csrfToken = request.headers.get('X-CSRF-Token');

  if (!verifyCSRFToken(csrfToken)) {
    return NextResponse.json({ error: 'Invalid CSRF token' }, { status: 403 });
  }

  // 処理を続行
}
```

### 3. レート制限

Vercelのエッジミドルウェアでレート制限を実装:

`middleware.ts`:

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '10 s'),
});

export async function middleware(request: NextRequest) {
  if (request.nextUrl.pathname.startsWith('/api/')) {
    const ip = request.ip ?? '127.0.0.1';
    const { success } = await ratelimit.limit(ip);

    if (!success) {
      return NextResponse.json(
        { error: 'Too many requests' },
        { status: 429 }
      );
    }
  }

  return NextResponse.next();
}
```

### 4. 入力検証

すべてのAPIエンドポイントで入力検証を実施:

- 型チェック（Zod）
- 長さ制限
- 許可された値のみを受け入れる

---

## APIテスト方法

### 1. curlコマンドでのテスト

#### プロジェクト一覧取得

```bash
curl -X GET http://localhost:3000/api/projects
```

#### プロジェクト作成

```bash
curl -X POST http://localhost:3000/api/projects \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Project",
    "description": "This is a test project",
    "canvasData": {
      "components": []
    }
  }'
```

#### プロジェクト取得

```bash
curl -X GET http://localhost:3000/api/projects/550e8400-e29b-41d4-a716-446655440000
```

#### プロジェクト更新

```bash
curl -X PUT http://localhost:3000/api/projects/550e8400-e29b-41d4-a716-446655440000 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Project Name"
  }'
```

#### プロジェクト削除

```bash
curl -X DELETE http://localhost:3000/api/projects/550e8400-e29b-41d4-a716-446655440000
```

#### HTML エクスポート

```bash
curl -X GET http://localhost:3000/api/export/550e8400-e29b-41d4-a716-446655440000 \
  -o exported.html
```

### 2. Fetchでのテスト（ブラウザコンソール）

```javascript
// プロジェクト一覧取得
fetch('/api/projects')
  .then(res => res.json())
  .then(data => console.log(data));

// プロジェクト作成
fetch('/api/projects', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'My Project',
    description: 'Test',
    canvasData: { components: [] }
  })
})
  .then(res => res.json())
  .then(data => console.log(data));

// プロジェクト更新
fetch('/api/projects/YOUR-PROJECT-ID', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'Updated Name'
  })
})
  .then(res => res.json())
  .then(data => console.log(data));

// プロジェクト削除
fetch('/api/projects/YOUR-PROJECT-ID', {
  method: 'DELETE'
})
  .then(res => res.json())
  .then(data => console.log(data));
```

### 3. VS Code REST Client拡張機能

`tests/api.http`:

```http
### 変数定義
@baseUrl = http://localhost:3000
@projectId = 550e8400-e29b-41d4-a716-446655440000

### プロジェクト一覧取得
GET {{baseUrl}}/api/projects

### プロジェクト作成
POST {{baseUrl}}/api/projects
Content-Type: application/json

{
  "name": "Test Project",
  "description": "Created via REST Client",
  "canvasData": {
    "components": []
  }
}

### プロジェクト取得
GET {{baseUrl}}/api/projects/{{projectId}}

### プロジェクト更新
PUT {{baseUrl}}/api/projects/{{projectId}}
Content-Type: application/json

{
  "name": "Updated Project"
}

### プロジェクト削除
DELETE {{baseUrl}}/api/projects/{{projectId}}

### HTMLエクスポート
GET {{baseUrl}}/api/export/{{projectId}}
```

---

## まとめ

このドキュメントでは、Next.js 14 App RouterでのRESTful API実装の完全なガイドを提供しました。

### 実装したファイル

1. **`src/app/api/projects/route.ts`** - プロジェクト一覧取得・作成
2. **`src/app/api/projects/[id]/route.ts`** - プロジェクト詳細・更新・削除
3. **`src/app/api/export/[id]/route.ts`** - HTML/CSSエクスポート
4. **`src/lib/export/html-generator.ts`** - HTML生成ユーティリティ
5. **`src/types/api.ts`** - API型定義
6. **`src/lib/api/error-handler.ts`** - エラーハンドリング
7. **`src/lib/validation/schemas.ts`** - バリデーションスキーマ

### 主要な概念

- **RESTful設計**: リソース中心、適切なHTTPメソッドの使用
- **型安全性**: TypeScriptとZodによる厳密な型チェック
- **エラーハンドリング**: 統一的で明確なエラーレスポンス
- **セキュリティ**: XSS、CSRF対策の実装
- **テスタビリティ**: curl、Fetch、REST Clientでの簡単なテスト

### 次のステップ

次のドキュメント「20251021_05-common-ui-components.md」では、再利用可能なUIコンポーネントの実装を解説します。
